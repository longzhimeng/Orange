     1                                  ; ==========================================
     2                                  ; pmtest2.asm
     3                                  ; 编译方法：nasm pmtest2.asm -o pmtest2.com
     4                                  ; ==========================================
     5                                  
     6                                  %include	"pm.inc"	; 常量, 宏, 以及一些说明
     7                              <1> 
     8                              <1> 
     9                              <1> ; 描述符图示
    10                              <1> 
    11                              <1> ; 图示一
    12                              <1> ;
    13                              <1> ;  ------ ┏━━┳━━┓高地址
    14                              <1> ;         ┃ 7  ┃ 段 ┃
    15                              <1> ;         ┣━━┫    ┃
    16                              <1> ;                  基
    17                              <1> ;  字节 7 ┆    ┆    ┆
    18                              <1> ;                  址
    19                              <1> ;         ┣━━┫ ② ┃
    20                              <1> ;         ┃ 0  ┃    ┃
    21                              <1> ;  ------ ┣━━╋━━┫
    22                              <1> ;         ┃ 7  ┃ G  ┃
    23                              <1> ;         ┣━━╉──┨
    24                              <1> ;         ┃ 6  ┃ D  ┃
    25                              <1> ;         ┣━━╉──┨
    26                              <1> ;         ┃ 5  ┃ 0  ┃
    27                              <1> ;         ┣━━╉──┨
    28                              <1> ;         ┃ 4  ┃ AVL┃
    29                              <1> ;  字节 6 ┣━━╉──┨
    30                              <1> ;         ┃ 3  ┃    ┃
    31                              <1> ;         ┣━━┫ 段 ┃
    32                              <1> ;         ┃ 2  ┃ 界 ┃
    33                              <1> ;         ┣━━┫ 限 ┃
    34                              <1> ;         ┃ 1  ┃    ┃
    35                              <1> ;         ┣━━┫ ② ┃
    36                              <1> ;         ┃ 0  ┃    ┃
    37                              <1> ;  ------ ┣━━╋━━┫
    38                              <1> ;         ┃ 7  ┃ P  ┃
    39                              <1> ;         ┣━━╉──┨
    40                              <1> ;         ┃ 6  ┃    ┃
    41                              <1> ;         ┣━━┫ DPL┃
    42                              <1> ;         ┃ 5  ┃    ┃
    43                              <1> ;         ┣━━╉──┨
    44                              <1> ;         ┃ 4  ┃ S  ┃
    45                              <1> ;  字节 5 ┣━━╉──┨
    46                              <1> ;         ┃ 3  ┃    ┃
    47                              <1> ;         ┣━━┫ T  ┃
    48                              <1> ;         ┃ 2  ┃ Y  ┃
    49                              <1> ;         ┣━━┫ P  ┃
    50                              <1> ;         ┃ 1  ┃ E  ┃
    51                              <1> ;         ┣━━┫    ┃
    52                              <1> ;         ┃ 0  ┃    ┃
    53                              <1> ;  ------ ┣━━╋━━┫
    54                              <1> ;         ┃ 23 ┃    ┃
    55                              <1> ;         ┣━━┫    ┃
    56                              <1> ;         ┃ 22 ┃    ┃
    57                              <1> ;         ┣━━┫ 段 ┃
    58                              <1> ;
    59                              <1> ;   字节  ┆    ┆ 基 ┆
    60                              <1> ; 2, 3, 4
    61                              <1> ;         ┣━━┫ 址 ┃
    62                              <1> ;         ┃ 1  ┃ ① ┃
    63                              <1> ;         ┣━━┫    ┃
    64                              <1> ;         ┃ 0  ┃    ┃
    65                              <1> ;  ------ ┣━━╋━━┫
    66                              <1> ;         ┃ 15 ┃    ┃
    67                              <1> ;         ┣━━┫    ┃
    68                              <1> ;         ┃ 14 ┃    ┃
    69                              <1> ;         ┣━━┫ 段 ┃
    70                              <1> ;
    71                              <1> ; 字节 0,1┆    ┆ 界 ┆
    72                              <1> ;
    73                              <1> ;         ┣━━┫ 限 ┃
    74                              <1> ;         ┃ 1  ┃ ① ┃
    75                              <1> ;         ┣━━┫    ┃
    76                              <1> ;         ┃ 0  ┃    ┃
    77                              <1> ;  ------ ┗━━┻━━┛低地址
    78                              <1> ;
    79                              <1> 
    80                              <1> 
    81                              <1> ; 图示二
    82                              <1> 
    83                              <1> ; 高地址………………………………………………………………………低地址
    84                              <1> 
    85                              <1> ; |   7   |   6   |   5   |   4   |   3   |   2   |   1   |   0    |
    86                              <1> ; |7654321076543210765432107654321076543210765432107654321076543210|	<- 共 8 字节
    87                              <1> ; |--------========--------========--------========--------========|
    88                              <1> ; ┏━━━┳━━━━━━━┳━━━━━━━━━━━┳━━━━━━━┓
    89                              <1> ; ┃31..24┃   (见下图)   ┃     段基址(23..0)    ┃ 段界限(15..0)┃
    90                              <1> ; ┃      ┃              ┃                      ┃              ┃
    91                              <1> ; ┃ 基址2┃③│②│    ①┃基址1b│   基址1a     ┃    段界限1   ┃
    92                              <1> ; ┣━━━╋━━━┳━━━╋━━━━━━━━━━━╋━━━━━━━┫
    93                              <1> ; ┃   %6 ┃  %5  ┃  %4  ┃  %3  ┃     %2       ┃       %1     ┃
    94                              <1> ; ┗━━━┻━━━┻━━━┻━━━┻━━━━━━━┻━━━━━━━┛
    95                              <1> ;         │                \_________
    96                              <1> ;         │                          \__________________
    97                              <1> ;         │                                             \________________________________________________
    98                              <1> ;         │                                                                                              ;         ┏━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━
    99                              <1> ;         ┃ 7  ┃ 6  ┃ 5  ┃ 4  ┃ 3  ┃ 2  ┃ 1  ┃ 0  ┃ 7  ┃ 6  ┃ 5  ┃ 4  ┃ 3  ┃ 2  ┃ 1  ┃ 0  ┃
   100                              <1> ;         ┣━━╋━━╋━━╋━━╋━━┻━━┻━━┻━━╋━━╋━━┻━━╋━━╋━━┻━━┻━━┻━━┫
   101                              <1> ;         ┃ G  ┃D/B ┃ 0  ┃ AVL┃   段界限 2 (19..16)  ┃  P ┃   DPL    ┃ S  ┃       TYPE           ┃
   102                              <1> ;         ┣━━┻━━┻━━┻━━╋━━━━━━━━━━━╋━━┻━━━━━┻━━┻━━━━━━━━━━━┫
   103                              <1> ;         ┃      ③: 属性 2      ┃    ②: 段界限 2      ┃                   ①: 属性1                  ┃
   104                              <1> ;         ┗━━━━━━━━━━━┻━━━━━━━━━━━┻━━━━━━━━━━━━━━━━━━━━━━━┛
   105                              <1> ;       高地址                                                                                          低地址
   106                              <1> ;
   107                              <1> ;
   108                              <1> 
   109                              <1> ; 说明:
   110                              <1> ;
   111                              <1> ; (1) P:    存在(Present)位。
   112                              <1> ;		P=1 表示描述符对地址转换是有效的，或者说该描述符所描述的段存在，即在内存中；
   113                              <1> ;		P=0 表示描述符对地址转换无效，即该段不存在。使用该描述符进行内存访问时会引起异常。
   114                              <1> ;
   115                              <1> ; (2) DPL:  表示描述符特权级(Descriptor Privilege level)，共2位。它规定了所描述段的特权级，用于特权检查，以决定对该段能否访问。 
   116                              <1> ;
   117                              <1> ; (3) S:   说明描述符的类型。
   118                              <1> ;		对于存储段描述符而言，S=1，以区别与系统段描述符和门描述符(S=0)。 
   119                              <1> ;
   120                              <1> ; (4) TYPE: 说明存储段描述符所描述的存储段的具体属性。
   121                              <1> ;
   122                              <1> ;		 
   123                              <1> ;	数据段类型	类型值		说明
   124                              <1> ;			----------------------------------
   125                              <1> ;			0		只读 
   126                              <1> ;			1		只读、已访问 
   127                              <1> ;			2		读/写 
   128                              <1> ;			3		读/写、已访问 
   129                              <1> ;			4		只读、向下扩展 
   130                              <1> ;			5		只读、向下扩展、已访问 
   131                              <1> ;			6		读/写、向下扩展 
   132                              <1> ;			7		读/写、向下扩展、已访问 
   133                              <1> ;
   134                              <1> ;		
   135                              <1> ;			类型值		说明
   136                              <1> ;	代码段类型	----------------------------------
   137                              <1> ;			8		只执行 
   138                              <1> ;			9		只执行、已访问 
   139                              <1> ;			A		执行/读 
   140                              <1> ;			B		执行/读、已访问 
   141                              <1> ;			C		只执行、一致码段 
   142                              <1> ;			D		只执行、一致码段、已访问 
   143                              <1> ;			E		执行/读、一致码段 
   144                              <1> ;			F		执行/读、一致码段、已访问 
   145                              <1> ;
   146                              <1> ;		
   147                              <1> ;	系统段类型	类型编码	说明
   148                              <1> ;			----------------------------------
   149                              <1> ;			0		<未定义>
   150                              <1> ;			1		可用286TSS
   151                              <1> ;			2		LDT
   152                              <1> ;			3		忙的286TSS
   153                              <1> ;			4		286调用门
   154                              <1> ;			5		任务门
   155                              <1> ;			6		286中断门
   156                              <1> ;			7		286陷阱门
   157                              <1> ;			8		未定义
   158                              <1> ;			9		可用386TSS
   159                              <1> ;			A		<未定义>
   160                              <1> ;			B		忙的386TSS
   161                              <1> ;			C		386调用门
   162                              <1> ;			D		<未定义>
   163                              <1> ;			E		386中断门
   164                              <1> ;			F		386陷阱门
   165                              <1> ;
   166                              <1> ; (5) G:    段界限粒度(Granularity)位。
   167                              <1> ;		G=0 表示界限粒度为字节；
   168                              <1> ;		G=1 表示界限粒度为4K 字节。
   169                              <1> ;           注意，界限粒度只对段界限有效，对段基地址无效，段基地址总是以字节为单位。 
   170                              <1> ;
   171                              <1> ; (6) D/B:  此位是一个很特殊的位，在描述可执行段、向下扩展数据段或由SS寄存器寻址的段(通常是堆栈段)的三种描述符中的意义各不相同。 
   172                              <1> ;           ⑴ 在描述可执行段的描述符中，D位决定了指令使用的地址及操作数所默认的大小。
   173                              <1> ;		① D=1表示默认情况下指令使用32位地址及32位或8位操作数，这样的代码段也称为32位代码段；
   174                              <1> ;		② D=0 表示默认情况下，使用16位地址及16位或8位操作数，这样的代码段也称为16位代码段，它与80286兼容。可以使用地址大小前缀和操作数大小前缀分别改变默认
   175                              <1> ;           ⑵ 在向下扩展数据段的描述符中，D位决定段的上部边界。
   176                              <1> ;		① D=1表示段的上部界限为4G；
   177                              <1> ;		② D=0表示段的上部界限为64K，这是为了与80286兼容。 
   178                              <1> ;           ⑶ 在描述由SS寄存器寻址的段描述符中，D位决定隐式的堆栈访问指令(如PUSH和POP指令)使用何种堆栈指针寄存器。
   179                              <1> ;		① D=1表示使用32位堆栈指针寄存器ESP；
   180                              <1> ;		② D=0表示使用16位堆栈指针寄存器SP，这与80286兼容。 
   181                              <1> ;
   182                              <1> ; (7) AVL:  软件可利用位。80386对该位的使用未左规定，Intel公司也保证今后开发生产的处理器只要与80386兼容，就不会对该位的使用做任何定义或规定。 
   183                              <1> ;
   184                              <1> 
   185                              <1> 
   186                              <1> ;----------------------------------------------------------------------------
   187                              <1> ; 描述符类型值说明
   188                              <1> ; 其中:
   189                              <1> ;       DA_  : Descriptor Attribute
   190                              <1> ;       D    : 数据段
   191                              <1> ;       C    : 代码段
   192                              <1> ;       S    : 系统段
   193                              <1> ;       R    : 只读
   194                              <1> ;       RW   : 读写
   195                              <1> ;       A    : 已访问
   196                              <1> ;       其它 : 可按照字面意思理解
   197                              <1> ;----------------------------------------------------------------------------
   198                              <1> DA_32		EQU	4000h	; 32 位段
   199                              <1> 
   200                              <1> DA_DPL0		EQU	  00h	; DPL = 0
   201                              <1> DA_DPL1		EQU	  20h	; DPL = 1
   202                              <1> DA_DPL2		EQU	  40h	; DPL = 2
   203                              <1> DA_DPL3		EQU	  60h	; DPL = 3
   204                              <1> ;----------------------------------------------------------------------------
   205                              <1> ; 存储段描述符类型值说明
   206                              <1> ;----------------------------------------------------------------------------
   207                              <1> DA_DR		EQU	90h	; 存在的只读数据段类型值
   208                              <1> DA_DRW		EQU	92h	; 存在的可读写数据段属性值
   209                              <1> DA_DRWA		EQU	93h	; 存在的已访问可读写数据段类型值
   210                              <1> DA_C		EQU	98h	; 存在的只执行代码段属性值
   211                              <1> DA_CR		EQU	9Ah	; 存在的可执行可读代码段属性值
   212                              <1> DA_CCO		EQU	9Ch	; 存在的只执行一致代码段属性值
   213                              <1> DA_CCOR		EQU	9Eh	; 存在的可执行可读一致代码段属性值
   214                              <1> ;----------------------------------------------------------------------------
   215                              <1> ; 系统段描述符类型值说明
   216                              <1> ;----------------------------------------------------------------------------
   217                              <1> DA_LDT		EQU	  82h	; 局部描述符表段类型值
   218                              <1> DA_TaskGate	EQU	  85h	; 任务门类型值
   219                              <1> DA_386TSS	EQU	  89h	; 可用 386 任务状态段类型值
   220                              <1> DA_386CGate	EQU	  8Ch	; 386 调用门类型值
   221                              <1> DA_386IGate	EQU	  8Eh	; 386 中断门类型值
   222                              <1> DA_386TGate	EQU	  8Fh	; 386 陷阱门类型值
   223                              <1> ;----------------------------------------------------------------------------
   224                              <1> 
   225                              <1> 
   226                              <1> ; 选择子图示:
   227                              <1> ;         ┏━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┓
   228                              <1> ;         ┃ 15 ┃ 14 ┃ 13 ┃ 12 ┃ 11 ┃ 10 ┃ 9  ┃ 8  ┃ 7  ┃ 6  ┃ 5  ┃ 4  ┃ 3  ┃ 2  ┃ 1  ┃ 0  ┃
   229                              <1> ;         ┣━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━╋━━╋━━┻━━┫
   230                              <1> ;         ┃                                 描述符索引                                 ┃ TI ┃   RPL    ┃
   231                              <1> ;         ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┻━━┻━━━━━┛
   232                              <1> ;
   233                              <1> ; RPL(Requested Privilege Level): 请求特权级，用于特权检查。
   234                              <1> ;
   235                              <1> ; TI(Table Indicator): 引用描述符表指示位
   236                              <1> ;	TI=0 指示从全局描述符表GDT中读取描述符；
   237                              <1> ;	TI=1 指示从局部描述符表LDT中读取描述符。
   238                              <1> ;
   239                              <1> 
   240                              <1> ;----------------------------------------------------------------------------
   241                              <1> ; 选择子类型值说明
   242                              <1> ; 其中:
   243                              <1> ;       SA_  : Selector Attribute
   244                              <1> 
   245                              <1> SA_RPL0		EQU	0	; ┓
   246                              <1> SA_RPL1		EQU	1	; ┣ RPL
   247                              <1> SA_RPL2		EQU	2	; ┃
   248                              <1> SA_RPL3		EQU	3	; ┛
   249                              <1> 
   250                              <1> SA_TIG		EQU	0	; ┓TI
   251                              <1> SA_TIL		EQU	4	; ┛
   252                              <1> ;----------------------------------------------------------------------------
   253                              <1> 
   254                              <1> 
   255                              <1> 
   256                              <1> 
   257                              <1> 
   258                              <1> ; 宏 ------------------------------------------------------------------------------------------------------
   259                              <1> ;
   260                              <1> ; 描述符
   261                              <1> ; usage: Descriptor Base, Limit, Attr
   262                              <1> ;        Base:  dd
   263                              <1> ;        Limit: dd (low 20 bits available)
   264                              <1> ;        Attr:  dw (lower 4 bits of higher byte are always 0)
   265                              <1> %macro Descriptor 3
   266                              <1> 	dw	%2 & 0FFFFh				; 段界限 1				(2 字节)
   267                              <1> 	dw	%1 & 0FFFFh				; 段基址 1				(2 字节)
   268                              <1> 	db	(%1 >> 16) & 0FFh			; 段基址 2				(1 字节)
   269                              <1> 	dw	((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)	; 属性 1 + 段界限 2 + 属性 2		(2 字节)
   270                              <1> 	db	(%1 >> 24) & 0FFh			; 段基址 3				(1 字节)
   271                              <1> %endmacro ; 共 8 字节
   272                              <1> ;
   273                              <1> ; 门
   274                              <1> ; usage: Gate Selector, Offset, DCount, Attr
   275                              <1> ;        Selector:  dw
   276                              <1> ;        Offset:    dd
   277                              <1> ;        DCount:    db
   278                              <1> ;        Attr:      db
   279                              <1> %macro Gate 4
   280                              <1> 	dw	(%2 & 0FFFFh)				; 偏移 1				(2 字节)
   281                              <1> 	dw	%1					; 选择子				(2 字节)
   282                              <1> 	dw	(%3 & 1Fh) | ((%4 << 8) & 0FF00h)	; 属性					(2 字节)
   283                              <1> 	dw	((%2 >> 16) & 0FFFFh)			; 偏移 2				(2 字节)
   284                              <1> %endmacro ; 共 8 字节
   285                              <1> ; ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   286                                  
   287                                  org	0100h
   288 00000000 E9(0000)                	jmp	LABEL_BEGIN
   289                                  
   290                                  [SECTION .gdt]
   291                                  ; GDT
   292                                  ;                            段基址,        段界限 , 属性
   293                                  LABEL_GDT:         Descriptor    0,              0, 0         ; 空描述符
   294                              <1> LABEL_GDT: 
   295 00000000 0000                <1>  dw %2 & 0FFFFh
   296 00000002 0000                <1>  dw %1 & 0FFFFh
   297 00000004 00                  <1>  db (%1 >> 16) & 0FFh
   298 00000005 0000                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   299 00000007 00                  <1>  db (%1 >> 24) & 0FFh
   300                                  LABEL_DESC_NORMAL: Descriptor    0,         0ffffh, DA_DRW    ; Normal 描述符
   301                              <1> LABEL_DESC_NORMAL: 
   302 00000008 FFFF                <1>  dw %2 & 0FFFFh
   303 0000000A 0000                <1>  dw %1 & 0FFFFh
   304 0000000C 00                  <1>  db (%1 >> 16) & 0FFh
   305 0000000D 9200                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   306 0000000F 00                  <1>  db (%1 >> 24) & 0FFh
   307                                  LABEL_DESC_CODE32: Descriptor    0, SegCode32Len-1, DA_C+DA_32; 非一致代码段, 32
   308                              <1> LABEL_DESC_CODE32: 
   309 00000010 CC00                <1>  dw %2 & 0FFFFh
   310 00000012 0000                <1>  dw %1 & 0FFFFh
   311 00000014 00                  <1>  db (%1 >> 16) & 0FFh
   312 00000015 9840                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   313 00000017 00                  <1>  db (%1 >> 24) & 0FFh
   314                                  LABEL_DESC_CODE16: Descriptor    0,         0ffffh, DA_C      ; 非一致代码段, 16
   315                              <1> LABEL_DESC_CODE16: 
   316 00000018 FFFF                <1>  dw %2 & 0FFFFh
   317 0000001A 0000                <1>  dw %1 & 0FFFFh
   318 0000001C 00                  <1>  db (%1 >> 16) & 0FFh
   319 0000001D 9800                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   320 0000001F 00                  <1>  db (%1 >> 24) & 0FFh
   321                                  LABEL_DESC_DATA:   Descriptor    0,      DataLen-1, DA_DRW    ; Data
   322                              <1> LABEL_DESC_DATA: 
   323 00000020 3500                <1>  dw %2 & 0FFFFh
   324 00000022 0000                <1>  dw %1 & 0FFFFh
   325 00000024 00                  <1>  db (%1 >> 16) & 0FFh
   326 00000025 9200                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   327 00000027 00                  <1>  db (%1 >> 24) & 0FFh
   328                                  LABEL_DESC_STACK:  Descriptor    0,     TopOfStack, DA_DRWA+DA_32; Stack, 32 位
   329                              <1> LABEL_DESC_STACK: 
   330 00000028 FF01                <1>  dw %2 & 0FFFFh
   331 0000002A 0000                <1>  dw %1 & 0FFFFh
   332 0000002C 00                  <1>  db (%1 >> 16) & 0FFh
   333 0000002D 9340                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   334 0000002F 00                  <1>  db (%1 >> 24) & 0FFh
   335                                  LABEL_DESC_TEST:   Descriptor 0500000h,     0ffffh, DA_DRW
   336                              <1> LABEL_DESC_TEST: 
   337 00000030 FFFF                <1>  dw %2 & 0FFFFh
   338 00000032 0000                <1>  dw %1 & 0FFFFh
   339 00000034 50                  <1>  db (%1 >> 16) & 0FFh
   340 00000035 9200                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   341 00000037 00                  <1>  db (%1 >> 24) & 0FFh
   342                                  LABEL_DESC_VIDEO:  Descriptor  0B8000h,     0ffffh, DA_DRW    ; 显存首地址
   343                              <1> LABEL_DESC_VIDEO: 
   344 00000038 FFFF                <1>  dw %2 & 0FFFFh
   345 0000003A 0080                <1>  dw %1 & 0FFFFh
   346 0000003C 0B                  <1>  db (%1 >> 16) & 0FFh
   347 0000003D 9200                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   348 0000003F 00                  <1>  db (%1 >> 24) & 0FFh
   349                                  ; GDT 结束
   350                                  
   351                                  GdtLen		equ	$ - LABEL_GDT	; GDT长度
   352 00000040 3F00                    GdtPtr		dw	GdtLen - 1	; GDT界限
   353 00000042 00000000                		dd	0		; GDT基地址
   354                                  
   355                                  ; GDT 选择子
   356                                  SelectorNormal		equ	LABEL_DESC_NORMAL	- LABEL_GDT
   357                                  SelectorCode32		equ	LABEL_DESC_CODE32	- LABEL_GDT
   358                                  SelectorCode16		equ	LABEL_DESC_CODE16	- LABEL_GDT
   359                                  SelectorData		equ	LABEL_DESC_DATA		- LABEL_GDT
   360                                  SelectorStack		equ	LABEL_DESC_STACK	- LABEL_GDT
   361                                  SelectorTest		equ	LABEL_DESC_TEST		- LABEL_GDT
   362                                  SelectorVideo		equ	LABEL_DESC_VIDEO	- LABEL_GDT
   363                                  ; END of [SECTION .gdt]
   364                                  
   365                                  [SECTION .data1]	 ; 数据段
   366                                  ALIGN	32
   367                                  [BITS	32]
   368                                  LABEL_DATA:
   369 00000000 0000                    SPValueInRealMode	dw	0
   370                                  ; 字符串
   371 00000002 496E2050726F746563-     PMMessage:		db	"In Protect Mode now. ^-^", 0	; 在保护模式中显示
   372 0000000B 74204D6F6465206E6F-
   373 00000014 772E205E2D5E00     
   374                                  OffsetPMMessage		equ	PMMessage - $$
   375 0000001B 414243444546474849-     StrTest:		db	"ABCDEFGHIJKLMNOPQRSTUVWXYZ", 0
   376 00000024 4A4B4C4D4E4F505152-
   377 0000002D 535455565758595A00 
   378                                  OffsetStrTest		equ	StrTest - $$
   379                                  DataLen			equ	$ - LABEL_DATA
   380                                  ; END of [SECTION .data1]
   381                                  
   382                                  
   383                                  ; 全局堆栈段
   384                                  [SECTION .gs]
   385                                  ALIGN	32
   386                                  [BITS	32]
   387                                  LABEL_STACK:
   388 00000000 00<rept>                	times 512 db 0
   389                                  
   390                                  TopOfStack	equ	$ - LABEL_STACK - 1
   391                                  
   392                                  ; END of [SECTION .gs]
   393                                  
   394                                  
   395                                  [SECTION .s16]
   396                                  [BITS	16]
   397                                  LABEL_BEGIN:
   398 00000000 8CC8                    	mov	ax, cs
   399 00000002 8ED8                    	mov	ds, ax
   400 00000004 8EC0                    	mov	es, ax
   401 00000006 8ED0                    	mov	ss, ax
   402 00000008 BC0001                  	mov	sp, 0100h
   403                                  
   404 0000000B A3[1800]                	mov	[LABEL_GO_BACK_TO_REAL+3], ax
   405 0000000E 8926[0000]              	mov	[SPValueInRealMode], sp
   406                                  
   407                                  	; 初始化 16 位代码段描述符
   408 00000012 8CC8                    	mov	ax, cs
   409 00000014 660FB7C0                	movzx	eax, ax
   410 00000018 66C1E004                	shl	eax, 4
   411 0000001C 6605[00000000]          	add	eax, LABEL_SEG_CODE16
   412 00000022 A3[1A00]                	mov	word [LABEL_DESC_CODE16 + 2], ax
   413 00000025 66C1E810                	shr	eax, 16
   414 00000029 A2[1C00]                	mov	byte [LABEL_DESC_CODE16 + 4], al
   415 0000002C 8826[1F00]              	mov	byte [LABEL_DESC_CODE16 + 7], ah
   416                                  
   417                                  	; 初始化 32 位代码段描述符
   418 00000030 6631C0                  	xor	eax, eax
   419 00000033 8CC8                    	mov	ax, cs
   420 00000035 66C1E004                	shl	eax, 4
   421 00000039 6605[00000000]          	add	eax, LABEL_SEG_CODE32
   422 0000003F A3[1200]                	mov	word [LABEL_DESC_CODE32 + 2], ax
   423 00000042 66C1E810                	shr	eax, 16
   424 00000046 A2[1400]                	mov	byte [LABEL_DESC_CODE32 + 4], al
   425 00000049 8826[1700]              	mov	byte [LABEL_DESC_CODE32 + 7], ah
   426                                  
   427                                  	; 初始化数据段描述符
   428 0000004D 6631C0                  	xor	eax, eax
   429 00000050 8CD8                    	mov	ax, ds
   430 00000052 66C1E004                	shl	eax, 4
   431 00000056 6605[00000000]          	add	eax, LABEL_DATA
   432 0000005C A3[2200]                	mov	word [LABEL_DESC_DATA + 2], ax
   433 0000005F 66C1E810                	shr	eax, 16
   434 00000063 A2[2400]                	mov	byte [LABEL_DESC_DATA + 4], al
   435 00000066 8826[2700]              	mov	byte [LABEL_DESC_DATA + 7], ah
   436                                  
   437                                  	; 初始化堆栈段描述符
   438 0000006A 6631C0                  	xor	eax, eax
   439 0000006D 8CD8                    	mov	ax, ds
   440 0000006F 66C1E004                	shl	eax, 4
   441 00000073 6605[00000000]          	add	eax, LABEL_STACK
   442 00000079 A3[2A00]                	mov	word [LABEL_DESC_STACK + 2], ax
   443 0000007C 66C1E810                	shr	eax, 16
   444 00000080 A2[2C00]                	mov	byte [LABEL_DESC_STACK + 4], al
   445 00000083 8826[2F00]              	mov	byte [LABEL_DESC_STACK + 7], ah
   446                                  
   447                                  	; 为加载 GDTR 作准备
   448 00000087 6631C0                  	xor	eax, eax
   449 0000008A 8CD8                    	mov	ax, ds
   450 0000008C 66C1E004                	shl	eax, 4
   451 00000090 6605[00000000]          	add	eax, LABEL_GDT		; eax <- gdt 基地址
   452 00000096 66A3[4200]              	mov	dword [GdtPtr + 2], eax	; [GdtPtr + 2] <- gdt 基地址
   453                                  
   454                                  	; 加载 GDTR
   455 0000009A 0F0116[4000]            	lgdt	[GdtPtr]
   456                                  
   457                                  	; 关中断
   458 0000009F FA                      	cli
   459                                  
   460                                  	; 打开地址线A20
   461 000000A0 E492                    	in	al, 92h
   462 000000A2 0C02                    	or	al, 00000010b
   463 000000A4 E692                    	out	92h, al
   464                                  
   465                                  	; 准备切换到保护模式
   466 000000A6 0F20C0                  	mov	eax, cr0
   467 000000A9 6683C801                	or	eax, 1
   468 000000AD 0F22C0                  	mov	cr0, eax
   469                                  
   470                                  	; 真正进入保护模式
   471 000000B0 66EA000000001000        	jmp	dword SelectorCode32:0	; 执行这一句会把 SelectorCode32 装入 cs, 并跳转到 Code32Selector:0  处
   472                                  
   473                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   474                                  
   475                                  LABEL_REAL_ENTRY:		; 从保护模式跳回到实模式就到了这里
   476 000000B8 8CC8                    	mov	ax, cs
   477 000000BA 8ED8                    	mov	ds, ax
   478 000000BC 8EC0                    	mov	es, ax
   479 000000BE 8ED0                    	mov	ss, ax
   480                                  
   481 000000C0 8B26[0000]              	mov	sp, [SPValueInRealMode]
   482                                  
   483 000000C4 E492                    	in	al, 92h		; `.
   484 000000C6 24FD                    	and	al, 11111101b	;  | 关闭 A20 地址线
   485 000000C8 E692                    	out	92h, al		; /
   486                                  
   487 000000CA FB                      	sti			; 开中断
   488                                  
   489 000000CB B8004C                  	mov	ax, 4c00h	; `.
   490 000000CE CD21                    	int	21h		; /  回到 DOS
   491                                  ; END of [SECTION .s16]
   492                                  
   493                                  
   494                                  [SECTION .s32]; 32 位代码段. 由实模式跳入.
   495                                  [BITS	32]
   496                                  
   497                                  LABEL_SEG_CODE32:
   498 00000000 66B82000                	mov	ax, SelectorData
   499 00000004 8ED8                    	mov	ds, ax			; 数据段选择子
   500 00000006 66B83000                	mov	ax, SelectorTest
   501 0000000A 8EC0                    	mov	es, ax			; 测试段选择子
   502 0000000C 66B83800                	mov	ax, SelectorVideo
   503 00000010 8EE8                    	mov	gs, ax			; 视频段选择子
   504                                  
   505 00000012 66B82800                	mov	ax, SelectorStack
   506 00000016 8ED0                    	mov	ss, ax			; 堆栈段选择子
   507                                  
   508 00000018 BCFF010000              	mov	esp, TopOfStack
   509                                  
   510                                  
   511                                  	; 下面显示一个字符串
   512 0000001D B40C                    	mov	ah, 0Ch			; 0000: 黑底    1100: 红字
   513 0000001F 31F6                    	xor	esi, esi
   514 00000021 31FF                    	xor	edi, edi
   515 00000023 BE02000000              	mov	esi, OffsetPMMessage	; 源数据偏移
   516 00000028 BF40060000              	mov	edi, (80 * 10 + 0) * 2	; 目的数据偏移。屏幕第 10 行, 第 0 列。
   517 0000002D FC                      	cld
   518                                  .1:
   519 0000002E AC                      	lodsb
   520 0000002F 84C0                    	test	al, al
   521 00000031 7409                    	jz	.2
   522 00000033 65668907                	mov	[gs:edi], ax
   523 00000037 83C702                  	add	edi, 2
   524 0000003A EBF2                    	jmp	.1
   525                                  .2:	; 显示完毕
   526                                  
   527 0000003C E875000000              	call	DispReturn
   528                                  
   529 00000041 E811000000              	call	TestRead
   530 00000046 E824000000              	call	TestWrite
   531 0000004B E807000000              	call	TestRead
   532                                  
   533                                  	; 到此停止
   534 00000050 EA000000001800          	jmp	SelectorCode16:0
   535                                  
   536                                  ; ------------------------------------------------------------------------
   537                                  TestRead:
   538 00000057 31F6                    	xor	esi, esi
   539 00000059 B908000000              	mov	ecx, 8
   540                                  .loop:
   541 0000005E 268A06                  	mov	al, [es:esi]
   542 00000061 E823000000              	call	DispAL
   543 00000066 46                      	inc	esi
   544 00000067 E2F5                    	loop	.loop
   545                                  
   546 00000069 E848000000              	call	DispReturn
   547                                  
   548 0000006E C3                      	ret
   549                                  ; TestRead 结束-----------------------------------------------------------
   550                                  
   551                                  
   552                                  ; ------------------------------------------------------------------------
   553                                  TestWrite:
   554 0000006F 56                      	push	esi
   555 00000070 57                      	push	edi
   556 00000071 31F6                    	xor	esi, esi
   557 00000073 31FF                    	xor	edi, edi
   558 00000075 BE1B000000              	mov	esi, OffsetStrTest	; 源数据偏移
   559 0000007A FC                      	cld
   560                                  .1:
   561 0000007B AC                      	lodsb
   562 0000007C 84C0                    	test	al, al
   563 0000007E 7406                    	jz	.2
   564 00000080 268807                  	mov	[es:edi], al
   565 00000083 47                      	inc	edi
   566 00000084 EBF5                    	jmp	.1
   567                                  .2:
   568                                  
   569 00000086 5F                      	pop	edi
   570 00000087 5E                      	pop	esi
   571                                  
   572 00000088 C3                      	ret
   573                                  ; TestWrite 结束----------------------------------------------------------
   574                                  
   575                                  
   576                                  ; ------------------------------------------------------------------------
   577                                  ; 显示 AL 中的数字
   578                                  ; 默认地:
   579                                  ;	数字已经存在 AL 中
   580                                  ;	edi 始终指向要显示的下一个字符的位置
   581                                  ; 被改变的寄存器:
   582                                  ;	ax, edi
   583                                  ; ------------------------------------------------------------------------
   584                                  DispAL:
   585 00000089 51                      	push	ecx
   586 0000008A 52                      	push	edx
   587                                  
   588 0000008B B40C                    	mov	ah, 0Ch			; 0000: 黑底    1100: 红字
   589 0000008D 88C2                    	mov	dl, al
   590 0000008F C0E804                  	shr	al, 4
   591 00000092 B902000000              	mov	ecx, 2
   592                                  .begin:
   593 00000097 240F                    	and	al, 01111b
   594 00000099 3C09                    	cmp	al, 9
   595 0000009B 7704                    	ja	.1
   596 0000009D 0430                    	add	al, '0'
   597 0000009F EB04                    	jmp	.2
   598                                  .1:
   599 000000A1 2C0A                    	sub	al, 0Ah
   600 000000A3 0441                    	add	al, 'A'
   601                                  .2:
   602 000000A5 65668907                	mov	[gs:edi], ax
   603 000000A9 83C702                  	add	edi, 2
   604                                  
   605 000000AC 88D0                    	mov	al, dl
   606 000000AE E2E7                    	loop	.begin
   607 000000B0 83C702                  	add	edi, 2
   608                                  
   609 000000B3 5A                      	pop	edx
   610 000000B4 59                      	pop	ecx
   611                                  
   612 000000B5 C3                      	ret
   613                                  ; DispAL 结束-------------------------------------------------------------
   614                                  
   615                                  
   616                                  ; ------------------------------------------------------------------------
   617                                  DispReturn:
   618 000000B6 50                      	push	eax
   619 000000B7 53                      	push	ebx
   620 000000B8 89F8                    	mov	eax, edi
   621 000000BA B3A0                    	mov	bl, 160
   622 000000BC F6F3                    	div	bl
   623 000000BE 25FF000000              	and	eax, 0FFh
   624 000000C3 40                      	inc	eax
   625 000000C4 B3A0                    	mov	bl, 160
   626 000000C6 F6E3                    	mul	bl
   627 000000C8 89C7                    	mov	edi, eax
   628 000000CA 5B                      	pop	ebx
   629 000000CB 58                      	pop	eax
   630                                  
   631 000000CC C3                      	ret
   632                                  ; DispReturn 结束---------------------------------------------------------
   633                                  
   634                                  SegCode32Len	equ	$ - LABEL_SEG_CODE32
   635                                  ; END of [SECTION .s32]
   636                                  
   637                                  
   638                                  ; 16 位代码段. 由 32 位代码段跳入, 跳出后到实模式
   639                                  [SECTION .s16code]
   640                                  ALIGN	32
   641                                  [BITS	16]
   642                                  LABEL_SEG_CODE16:
   643                                  	; 跳回实模式:
   644 00000000 B80800                  	mov	ax, SelectorNormal
   645 00000003 8ED8                    	mov	ds, ax
   646 00000005 8EC0                    	mov	es, ax
   647 00000007 8EE0                    	mov	fs, ax
   648 00000009 8EE8                    	mov	gs, ax
   649 0000000B 8ED0                    	mov	ss, ax
   650                                  
   651 0000000D 0F20C0                  	mov	eax, cr0
   652 00000010 24FE                    	and	al, 11111110b
   653 00000012 0F22C0                  	mov	cr0, eax
   654                                  
   655                                  LABEL_GO_BACK_TO_REAL:
   656 00000015 EA[B800]0000            	jmp	0:LABEL_REAL_ENTRY	; 段地址会在程序开始处被设置成正确的值
   657                                  
   658                                  Code16Len	equ	$ - LABEL_SEG_CODE16
   659                                  
   660                                  ; END of [SECTION .s16code]
